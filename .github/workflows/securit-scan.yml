# name: Security Scans (Trivy)
# on:
#   push:
#     branches:
#       - '**'

#   pull_request:
#     branches:
#       - '**'

    
# jobs:
#   trivy-scan:
#     name: Trivy Security Scan
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v4
        
#  # Step 7: Install Trivy
#       - name: Install Trivy
#         run: |
#           sudo apt-get update
#           sudo apt-get install wget apt-transport-https gnupg lsb-release -y
#           wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
#           echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee /etc/apt/sources.list.d/trivy.list
#           sudo apt-get update
#           sudo apt-get install trivy -y
          
#  # Cache Trivy DB (database will auto-update on first scan if needed)
#       - name: Cache Trivy vulnerability database
#         uses: actions/cache@v4
#         with:
#           path: ~/.cache/trivy
#           key: ${{ runner.os }}-trivy-db
#           restore-keys: |
#             ${{ runner.os }}-trivy-



#         # Workaround: Copy .env files to names without .env for secret scanning
#       - name: Prepare .env files for scanning
#         id: prepare-env
#         run: |
#           echo "Finding .env files..."
#           counter=1
#           env_files=""
#           find . -type f \( -name "*.env" -o -name ".env*" \) -not -path "./.git/*" | while read file; do
#             new_name="secrets-for-scan-${counter}.txt"
#             echo "Copying $file to $new_name"
#             cp "$file" "$new_name"
#             echo "original: $file" >> .env-mapping.txt
#             echo "scanned: $new_name" >> .env-mapping.txt
#             counter=$((counter + 1))
#           done
          
#           if [ -f .env-mapping.txt ]; then
#             echo "=== .env files copied for scanning ==="
#             cat .env-mapping.txt
#           else
#             echo "No .env files found to scan"
#           fi
      
# # Secret Scanning (includes copied .env files)
#       - name: Trivy Secret Scan
#         run: |
#           echo "=== Trivy Secret Scan Results ==="
#           trivy fs . \
#             --scanners secret \
#             --severity CRITICAL,HIGH \
#             --format table \
#             --no-progress \
#             -o trivy-secret-report.txt || true
          
#           echo ""
#           echo "=== Secret Scan Summary ==="
#           cat trivy-secret-report.txt || echo "No secrets found"

#       # - name: Trivy Secret Scan
#       #   run: |
#       #     trivy fs . \
#       #       --scanners secret \
#       #       --secret-config trivy-secret.yaml \
#       #       --severity HIGH,CRITICAL \
#       #       --exit-code 1 \
#       #       --format table

#       # - name: Trivy Secret Scan (dedicated)
#       #   run: |
#       #     trivy fs . \
#       #       --scanners secret \
#       #       --severity HIGH,CRITICAL \
#       #       --exit-code 1 \
#       #       --format table

#    # Secret Scanning
#       # -------------------------
#       # - name: Trivy Secret Scan
#       #   run: |
#       #     trivy fs \
#       #       --scanners secret \
#       #       --severity HIGH,CRITICAL \
#       #       --exit-code 1 \
#       #      --file-patterns "text:.*\.env,text:.*\.txt,text:.*\.tf" \
#       #       .

#       # - name: Trivy Secret Scan (with .env files)
#       #   run: |
#       #     trivy fs . \
#       #     --scanners secret \
#       #     --disable-allow-rules \
#       #     --severity HIGH,CRITICAL \
#       #     --exit-code 1 \
#       #     --format table
#         # -------------------------
#       # Vulnerability Scanning
#       # -------------------------
#       - name: Trivy Vulnerability Scan
#         run: |
#           trivy fs \
#             --scanners vuln \
#             --severity HIGH,CRITICAL \
#             --exit-code 1 \
#             .

#              # Misconfiguration / PCI Checks
#       # -------------------------
#       - name: Trivy Config Scan
#         run: |
#           trivy fs \
#             --scanners config \
#             --severity HIGH,CRITICAL \
#             --exit-code 1 \
#             .

#      # Cleanup temporary files
#       - name: Cleanup temporary files
#         if: always()
#         run: |
#           rm -f secrets-for-scan-*.txt .env-mapping.txt
#           echo "Cleaned up temporary files"

#       # Upload reports as artifacts (optional)
#       - name: Upload Trivy Secret Report
#         if: always()
#         uses: actions/upload-artifact@v4
#         with:
#           name: trivy-secret-report
#           path: trivy-secret-report.txt
#           retention-days: 7



# name: Security Scans (Trivy)
# on:
#   push:
#     branches: ['**']
#   pull_request:
#     branches: ['**']
    
# jobs:
#   trivy-scan:
#     name: Trivy Security Scan
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v4

#       - name: Install Trivy
#         run: |
#           sudo apt-get update
#           sudo apt-get install wget apt-transport-https gnupg lsb-release -y
#           wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
#           echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee /etc/apt/sources.list.d/trivy.list
#           sudo apt-get update
#           sudo apt-get install trivy -y

#       - name: Cache Trivy vulnerability database
#         uses: actions/cache@v4
#         with:
#           path: ~/.cache/trivy
#           key: ${{ runner.os }}-trivy-db
#           restore-keys: |
#             ${{ runner.os }}-trivy-

#       - name: Prepare .env files for scanning
#         run: |
#           [ -f trivy-secret.yaml ] && [ ! -s trivy-secret.yaml ] && rm -f trivy-secret.yaml || true
#           counter=1
#           find . -type f \( -name "*.env" -o -name ".env*" \) -not -path "./.git/*" | while read file; do
#             cp "$file" "secrets-for-scan-${counter}.txt"
#             ((counter++))
#           done

#       - name: Secret Scan
#         run: |
#           trivy fs . \
#             --scanners secret \
#             --severity CRITICAL,HIGH \
#             --exit-code 1

#       - name: Vulnerability Scan
#         run: |
#           trivy fs . \
#             --scanners vuln \
#             --severity HIGH,CRITICAL \
#             --exit-code 1

#       - name: Misconfiguration Scan
#         run: |
#           trivy fs . \
#             --scanners misconfig \
#             --misconfig-scanners dockerfile,kubernetes,terraform,cloudformation,yaml,json \
#             --config-check ./policies \
#             --severity MEDIUM,HIGH,CRITICAL \
#             --exit-code 1


name: Security Scans (Trivy)
on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']
    
jobs:
  trivy-scan:
    name: Trivy Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install wget apt-transport-https gnupg lsb-release -y
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy -y

      - name: Cache Trivy vulnerability database
        uses: actions/cache@v4
        with:
          path: ~/.cache/trivy
          key: ${{ runner.os }}-trivy-db
          restore-keys: |
            ${{ runner.os }}-trivy-

      # - name: Secret Scan
      #   run: |
      #     [ -f trivy-secret.yaml ] && [ ! -s trivy-secret.yaml ] && rm -f trivy-secret.yaml || true
      #     trivy fs . \
      #       --scanners secret \
      #       --severity CRITICAL,HIGH \
      #       --format table \
      #       --exit-code 1

      - name: Secret Scan
        run: |
          rm -f trivy-secret.yaml
          trivy fs . \
            --scanners secret \
            --severity CRITICAL,HIGH \
            --format table \
            --exit-code 1

      - name: Vulnerability Scan
        run: |
          trivy fs . \
            --scanners vuln \
            --severity HIGH,CRITICAL \
            --exit-code 1

      - name: Misconfiguration Scan
        run: |
          trivy fs . \
            --scanners misconfig \
            --misconfig-scanners dockerfile,kubernetes,terraform,cloudformation,yaml,json \
     #       --config-check ./policies \
            --severity MEDIUM,HIGH,CRITICAL \
            --exit-code 1
            

# #       - name: Cleanup
# #         if: always()
# #         run: |
#           rm -f secrets-for-scan-*.txt
